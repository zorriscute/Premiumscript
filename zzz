-- ================== CONFIG ==================
local FIREBASE = "https://voidwl-a3c43-default-rtdb.firebaseio.com"
local TAMPER_WEBHOOK = "https://discord.com/api/webhooks/1451328367440695366/oLJB7sO-7kqa4mw537o6orLFifqSEnVI4qHdHtKKcdiNPp2MQuInix-g72a91cjCYMZB"

-- ================== SERVICES ==================
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local LogService = game:GetService("LogService")
local StarterGui = game:GetService("StarterGui")
local VirtualUser = game:GetService("VirtualUser")
local RbxAnalytics = game:GetService("RbxAnalyticsService")

local player = Players.LocalPlayer
local hwid = RbxAnalytics:GetClientId()

-- ================== SAFE GETGENV ==================
local genv = getgenv and getgenv()
if type(genv) ~= "table" or type(genv.Key) ~= "string" then
    return
end

local USER_KEY = genv.Key
local excludedUsernames = genv.ExcludedUsernames or {}
local excludedUserIds = genv.ExcludedUserIds or {}
local BOOST_WEBHOOK = genv.BoostLoggerWebhook

-- ================== NOTIFY ==================
local function notify(text)
    pcall(function()
        StarterGui:SetCore("SendNotification", {
            Title = "Void Boosting",
            Text = text,
            Duration = 3
        })
    end)
end

notify("Authenticating...")

-- ================== TAMPER ALERT ==================
local function alert(reason)
    pcall(function()
        HttpService:PostAsync(
            TAMPER_WEBHOOK,
            HttpService:JSONEncode({
                content =
                    "**ðŸš¨ VOID TAMPER ALERT**\n" ..
                    "**User:** "..player.Name.."\n" ..
                    "**UserId:** "..player.UserId.."\n" ..
                    "**Reason:** "..reason
            }),
            Enum.HttpContentType.ApplicationJson
        )
    end)
end

-- ================== HTTP ==================
local function safeGET(url)
    local ok, res = pcall(function()
        return game:HttpGet(url)
    end)
    if ok then return res end
    alert("HttpGet failed")
    return nil
end

local function safePUT(url, data)
    pcall(function()
        game:HttpPost(
            url.."?print=silent",
            HttpService:JSONEncode(data),
            "application/json",
            false,
            "PUT"
        )
    end)
end

local function getFirebase(path)
    local res = safeGET(FIREBASE.."/"..path..".json")
    if not res then return nil end
    local decoded
    pcall(function()
        decoded = HttpService:JSONDecode(res)
    end)
    return decoded
end

-- ================== WHITELIST ==================
local function authenticate()
    local keyData = getFirebase("Keys/"..USER_KEY)

    if not keyData then
        notify("Invalid Key")
        alert("Invalid key")
        return false
    end

    if keyData.HWID then
        if keyData.HWID ~= hwid then
            notify("HWID Mismatch")
            alert("HWID mismatch")
            return false
        end
        notify("Executed!")
        return true
    end

    safePUT(FIREBASE.."/Keys/"..USER_KEY..".json", {
        HWID = hwid,
        Redeemed = true,
        LastReset = keyData.LastReset or 0
    })

    notify("HWID Locked!")
    task.wait(0.5)
    notify("Executed!")
    return true
end

if not authenticate() then
    return
end

-- ================== EXCLUSION CHECK ==================
if excludedUsernames[player.Name] or excludedUserIds[player.UserId] then
    return
end

-- ================== BOOSTING SCRIPT ==================
local rounds = 0
local maxRounds = 7
local rejoining = false
local lastRoundNotified = 0
local currentJobId = game.JobId

local function sendBoostWebhook(round)
    if not BOOST_WEBHOOK then return end
    pcall(function()
        HttpService:PostAsync(
            BOOST_WEBHOOK,
            HttpService:JSONEncode({
                content = player.Name.." completed round: "..round
            }),
            Enum.HttpContentType.ApplicationJson
        )
    end)
end

local function safeTeleport()
    TeleportService:TeleportToPlaceInstance(
        game.PlaceId,
        currentJobId,
        player
    )
end

local function incrementRounds()
    rounds += 1
    sendBoostWebhook(rounds)

    if lastRoundNotified ~= rounds then
        lastRoundNotified = rounds
        if rounds < maxRounds then
            notify("Round "..rounds.." completed!")
        elseif not rejoining then
            rejoining = true
            notify("MAX ROUNDS â€“ REJOINING")
            task.delay(1, safeTeleport)
        end
    end
end

-- ================== ANTI AFK ==================
task.spawn(function()
    while task.wait(60) do
        VirtualUser:CaptureController()
        VirtualUser:ClickButton1(Vector2.new(50,50))
        VirtualUser:MoveMouse(math.random(0,800), math.random(0,600))

        local char = player.Character
        local hum = char and char:FindFirstChildOfClass("Humanoid")
        if hum then
            hum:ChangeState(Enum.HumanoidStateType.Jumping)
        end
    end
end)

-- ================== LOG LISTENER ==================
local lastMessage = 0
LogService.MessageOut:Connect(function(msg)
    if os.clock() - lastMessage < 0.5 then return end
    lastMessage = os.clock()

    if msg:find("LOAD PROGRESS") then
        incrementRounds()
    end

    if msg:lower():find("idle") or msg:lower():find("kicked") then
        if not rejoining then
            rejoining = true
            notify("Idle detected â€“ Rejoining")
            task.delay(1, safeTeleport)
        end
    end
end)

player.OnTeleport:Connect(function()
    rounds = 0
    rejoining = false
    lastRoundNotified = 0
end)
